{"version":3,"file":"telemetryManager.js","sourceRoot":"","sources":["../../../../sourceES6/viewer/src/managers/telemetryManager.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,UAAU,EAAE,MAAM,iCAAiC,CAAC;AAgB7D;;GAEG;AACH;IAAA;QAEW,iCAA4B,GAA8B,IAAI,UAAU,EAAE,CAAC;QAI1E,WAAM,GAA8D,IAAI,CAAC,aAAa,CAAC;IAiGnG,CAAC;IA1FG,sBAAW,uCAAS;QALpB;;;;WAIG;aACH;YACI,OAAO,IAAI,CAAC,MAAM,CAAC;QACvB,CAAC;;;OAAA;IAED;;;OAGG;IACI,2CAAgB,GAAvB,UAAwB,MAAc,EAAE,QAAiB;QACrD,IAAI,CAAC,MAAM,EAAE;YACT,OAAO;SACV;QACD,IAAI,SAAS,GAAG,IAAI,CAAC;QAErB,OAAO,SAAS,EAAE;YACd,IAAI,KAAK,GAAG,MAAM,CAAC,QAAQ,EAAE,CAAC;YAC9B,IAAI,KAAK,KAAK,CAAC,EAAE;gBACb,SAAS,GAAG,KAAK,CAAC;aACrB;iBAAM;gBACH,IAAI,CAAC,SAAS,CAAC,aAAa,EAAE,QAAQ,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;aAC7D;SACJ;IACL,CAAC;IAMD,sBAAW,oCAAM;QAJjB;;;WAGG;aACH,UAAkB,OAAgB;YAC9B,IAAI,OAAO,EAAE;gBACT,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC;aACpC;iBAAM;gBACH,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,cAAc,CAAC;aACrC;QACL,CAAC;;;OAAA;IAED;;OAEG;IACK,yCAAc,GAAtB;QACI,gBAAgB;IACpB,CAAC;IAED;;;;OAIG;IACK,wCAAa,GAArB,UAAsB,KAAa,EAAE,QAAiB,EAAE,OAAa;QACjE,IAAI,aAAa,GAAkB;YAC/B,QAAQ,UAAA;YACR,KAAK,EAAE,KAAK;YACZ,OAAO,EAAE,IAAI,CAAC,OAAO;YACrB,IAAI,EAAE,IAAI,IAAI,EAAE;YAChB,GAAG,EAAE,MAAM,CAAC,WAAW,CAAC,CAAC,CAAC,MAAM,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE;YAC/D,MAAM,EAAE,IAAI;SACf,CAAC;QAEF,IAAI,OAAO,OAAO,KAAK,QAAQ,EAAE;YAC7B,KAAK,IAAI,IAAI,IAAI,OAAO,EAAE;gBACtB,IAAI,OAAO,CAAC,cAAc,CAAC,IAAI,CAAC,EAAE;oBAC9B,aAAa,CAAC,IAAI,CAAC,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC;iBACvC;aACJ;SACJ;aAAM,IAAI,OAAO,EAAE;YAChB,aAAa,CAAC,MAAM,GAAG,OAAO,CAAC;SAClC;QAED,IAAI,CAAC,4BAA4B,CAAC,eAAe,CAAC,aAAa,CAAC,CAAC;IACrE,CAAC;IAMD,sBAAW,qCAAO;QAJlB;;;WAGG;aACH;YACI,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE;gBACzB,qCAAqC;gBACrC,IAAI,CAAC,iBAAiB,GAAG,UAAU,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,OAAO,CAAC,CAAC;aAC1F;YACD,OAAO,IAAI,CAAC,iBAAiB,CAAC;QAClC,CAAC;;;OAAA;IAED;;OAEG;IACI,kCAAO,GAAd;QACI,IAAI,CAAC,4BAA4B,CAAC,KAAK,EAAE,CAAC;QAC1C,OAAO,IAAI,CAAC,4BAA4B,CAAC;IAC7C,CAAC;IACL,uBAAC;AAAD,CAAC,AAvGD,IAuGC;;AAED,MAAM,CAAC,IAAM,gBAAgB,GAAG,IAAI,gBAAgB,EAAE,CAAC","sourcesContent":["import { Observable } from \"@babylonjs/core/Misc/observable\";\r\nimport { Engine } from \"@babylonjs/core/Engines/engine\";\r\n\r\n\r\n/**\r\n * The data structure of a telemetry event.\r\n */\r\nexport interface TelemetryData {\r\n    event: string;\r\n    session: string;\r\n    date: Date;\r\n    now: number;\r\n    viewerId?: string;\r\n    detail: any;\r\n}\r\n\r\n/**\r\n * Receives Telemetry events and raises events to the API\r\n */\r\nexport class TelemetryManager {\r\n\r\n    public onEventBroadcastedObservable: Observable<TelemetryData> = new Observable();\r\n\r\n    private _currentSessionId: string;\r\n\r\n    private _event: (event: string, viewerId?: string, details?: any) => void = this._eventEnabled;\r\n\r\n    /**\r\n     * Receives a telemetry event\r\n     * @param event The name of the Telemetry event\r\n     * @param details An additional value, or an object containing a list of property/value pairs\r\n     */\r\n    public get broadcast() {\r\n        return this._event;\r\n    }\r\n\r\n    /**\r\n     * Log a Telemetry event for errors raised on the WebGL context.\r\n     * @param engine The Babylon engine with the WebGL context.\r\n     */\r\n    public flushWebGLErrors(engine: Engine, viewerId?: string) {\r\n        if (!engine) {\r\n            return;\r\n        }\r\n        let logErrors = true;\r\n\r\n        while (logErrors) {\r\n            let error = engine.getError();\r\n            if (error === 0) {\r\n                logErrors = false;\r\n            } else {\r\n                this.broadcast(\"WebGL Error\", viewerId, { error: error });\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Enable or disable telemetry events\r\n     * @param enabled Boolan, true if events are enabled\r\n     */\r\n    public set enable(enabled: boolean) {\r\n        if (enabled) {\r\n            this._event = this._eventEnabled;\r\n        } else {\r\n            this._event = this._eventDisabled;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Called on event when disabled, typically do nothing here\r\n     */\r\n    private _eventDisabled(): void {\r\n        // nothing to do\r\n    }\r\n\r\n    /**\r\n     * Called on event when enabled\r\n     * @param event - The name of the Telemetry event\r\n     * @param details An additional value, or an object containing a list of property/value pairs\r\n     */\r\n    private _eventEnabled(event: string, viewerId?: string, details?: any): void {\r\n        let telemetryData: TelemetryData = {\r\n            viewerId,\r\n            event: event,\r\n            session: this.session,\r\n            date: new Date(),\r\n            now: window.performance ? window.performance.now() : Date.now(),\r\n            detail: null\r\n        };\r\n\r\n        if (typeof details === \"object\") {\r\n            for (var attr in details) {\r\n                if (details.hasOwnProperty(attr)) {\r\n                    telemetryData[attr] = details[attr];\r\n                }\r\n            }\r\n        } else if (details) {\r\n            telemetryData.detail = details;\r\n        }\r\n\r\n        this.onEventBroadcastedObservable.notifyObservers(telemetryData);\r\n    }\r\n\r\n    /**\r\n     * Returns the current session ID or creates one if it doesn't exixt\r\n     * @return The current session ID\r\n     */\r\n    public get session(): string {\r\n        if (!this._currentSessionId) {\r\n            //String + Timestamp + Random Integer\r\n            this._currentSessionId = \"SESSION_\" + Date.now() + Math.floor(Math.random() * 0x10000);\r\n        }\r\n        return this._currentSessionId;\r\n    }\r\n\r\n    /**\r\n     * Disposes the telemetry manager\r\n     */\r\n    public dispose() {\r\n        this.onEventBroadcastedObservable.clear();\r\n        delete this.onEventBroadcastedObservable;\r\n    }\r\n}\r\n\r\nexport const telemetryManager = new TelemetryManager();\r\n"]}